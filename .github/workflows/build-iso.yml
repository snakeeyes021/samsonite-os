name: Build ISOs

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag to build (e.g., latest)'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["bluebuild"]
    types:
      - completed
    branches:
      - main

jobs:
  build-isos:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    name: Build ${{ matrix.image }} ISO
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - samsonite-os
          - samsonite-os-nvidia
          - samsonite-os-nvidia-legacy
    steps:
      # 1. CRITICAL: Free up ~20GB of space by removing Android SDKs, DotNet, etc.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # Optimizations to make this step faster
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout Repo
        uses: actions/checkout@v6

      - name: Determine Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "val=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "val=latest" >> $GITHUB_OUTPUT
          fi

      # HOTFIX: Remove broken 'terra' repos to prevent depsolve errors.
      # We run this as SUDO so the image lands directly in Root's storage.
      # This avoids the "no space left on device" error caused by duplicating the image via 'podman load'.
      - name: Patch Image (Remove Broken Repos)
        run: |
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.tag.outputs.val }}"
          
          # Pull and Patch directly as Root (Sudo)
          sudo podman pull $IMAGE_REF
          sudo podman run --name fixer $IMAGE_REF sh -c "rm -f /etc/yum.repos.d/terra*.repo"
          sudo podman commit fixer localhost/${{ matrix.image }}-fixed
          sudo podman rm fixer

      - name: Build ISO
        run: |
          mkdir -p ./output
          
          # We execute the builder container directly using the options the Action would have used
          # The image is already in sudo's storage from the previous step.
          sudo podman run \
            --rm \
            --privileged \
            --security-opt label=type:unconfined_t \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            -v ./output:/output \
            -v ./disk_config/iso.toml:/config.toml:ro \
            quay.io/centos-bootc/bootc-image-builder:stream9 \
            build \
            --output /output \
            --type anaconda-iso \
            --rootfs btrfs \
            localhost/${{ matrix.image }}-fixed

      - name: Rename Output
        id: rename
        run: |
          sudo find ./output -name "install.iso" -exec mv {} ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso \;

      - name: Upload ISO
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.image }}-${{ steps.tag.outputs.val }}-iso
          path: ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso
          # Keep artifacts for 90 days (max for public repos) so links don't break
          retention-days: 90