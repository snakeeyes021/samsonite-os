name: Build ISOs

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag to build (e.g., latest)'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["bluebuild"]
    types:
      - completed
    branches:
      - main

jobs:
  build-isos:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    name: Build ${{ matrix.image }} ISO
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - samsonite-os
          - samsonite-os-nvidia
          - samsonite-os-nvidia-legacy
    steps:
      # 1. CRITICAL: Free up ~20GB of space by removing Android SDKs, DotNet, etc.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # Optimizations to make this step faster
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Determine Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "val=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "val=latest" >> $GITHUB_OUTPUT
          fi

      # 2. HOTFIX: The 'terra-mesa' repo in F43 is missing local GPG keys, breaking the ISO builder.
      # We manually remove the terra repo definitions from a temporary copy of the image.
      - name: Patch Image (Remove Broken Repos)
        run: |
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.tag.outputs.val }}"
          
          # Pull the image
          podman pull $IMAGE_REF
          
          # Run a container to delete the broken repo config, then commit to a local tag
          # We force remove any repo file starting with 'terra'
          podman run --name fixer $IMAGE_REF sh -c "rm -f /etc/yum.repos.d/terra*.repo"
          podman commit fixer localhost/${{ matrix.image }}-fixed
          podman rm fixer

      - name: Build ISO
        uses: osbuild/bootc-image-builder-action@main
        with:
          types: anaconda-iso
          rootfs: btrfs
          config-file: ./disk_config/iso.toml
          # Point to our patched local image
          image: localhost/${{ matrix.image }}-fixed

      - name: Rename Output
        id: rename
        run: |
          mv ./output/anaconda-iso/install.iso ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.image }}-${{ steps.tag.outputs.val }}-iso
          path: ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso
          retention-days: 7