name: Build ISOs

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag to build (e.g., latest)'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["bluebuild"]
    types:
      - completed
    branches:
      - main

jobs:
  build-isos:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    name: Build ${{ matrix.image }} ISO
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - samsonite-os
          - samsonite-os-nvidia
          - samsonite-os-nvidia-legacy
    steps:
      # 1. CRITICAL: Free up ~20GB of space by removing Android SDKs, DotNet, etc.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # Optimizations to make this step faster
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout Repo
        uses: actions/checkout@v6

      - name: Determine Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "val=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "val=latest" >> $GITHUB_OUTPUT
          fi

      # 2. HOTFIX: Remove broken 'terra' repos to prevent depsolve errors.
      # We also MOVE the image to Root storage so the builder can see it.
      - name: Patch Image (Remove Broken Repos)
        run: |
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.tag.outputs.val }}"
          
          # 1. Pull and Patch as User (Rootless)
          podman pull $IMAGE_REF
          podman run --name fixer $IMAGE_REF sh -c "rm -f /etc/yum.repos.d/terra*.repo"
          podman commit fixer localhost/${{ matrix.image }}-fixed
          podman rm fixer

          # 2. Transfer to Root Storage
          # The ISO builder runs as sudo, so it needs the image in sudo's storage.
          podman save localhost/${{ matrix.image }}-fixed | sudo podman load

      # 3. BUILD ISO (Manual Mode)
      - name: Build ISO
        run: |
          mkdir -p ./output
          
          # We execute the builder container directly using the options the Action would have used
          # But we skip the 'pull' because the image is already in sudo's storage from the previous step.
          sudo podman run \
            --rm \
            --privileged \
            --security-opt label=type:unconfined_t \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            -v ./output:/output \
            -v ./disk_config/iso.toml:/config.toml:ro \
            quay.io/centos-bootc/bootc-image-builder:latest \
            build \
            --output /output \
            --type anaconda-iso \
            --rootfs btrfs \
            localhost/${{ matrix.image }}-fixed

      - name: Rename Output
        id: rename
        run: |
          mv ./output/anaconda-iso/install.iso ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.image }}-${{ steps.tag.outputs.val }}-iso
          path: ./${{ matrix.image }}-${{ steps.tag.outputs.val }}.iso
          retention-days: 7