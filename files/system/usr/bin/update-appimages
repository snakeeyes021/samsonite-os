#!/usr/bin/env bash

if ! flatpak list | grep -q "it.mijorus.gearlever"; then
    echo "Gearlever not installed. Skipping AppImage updates."
    exit 0
fi

echo "=== Updating AppImages ==="

APPS=$(flatpak run it.mijorus.gearlever --list-installed || true)

if [ -z "$APPS" ]; then
    echo "No AppImages managed by Gearlever found."
    exit 0
fi

echo "$APPS" | while read -r LINE; do
    # Fix: Use awk to get the clean file path
    APP_PATH=$(echo "$LINE" | awk '{print $NF}')
    
    if [ -n "$APP_PATH" ] && [ "$APP_PATH" != "managed" ]; then
        APP_NAME=$(basename "$APP_PATH")
        echo "-> Checking updates for $APP_NAME..."
        flatpak run it.mijorus.gearlever --update "$APP_PATH"
    fi
done

echo "AppImage update check complete."